---
title: "ANOVA: Part 2"
author: "University of Nebraska at Kearney Biology"
format: html
editor: visual
---

## Two-way ANOVA

Previously, we discussed one-way ANOVAs, where we are looking at a single factor split across three or more groups and trying to determine if the means of these groups are equal (*i.e.*, $H_0: \mu_1=\mu_2=...\mu_i$). ANOVA specifically allows us to analyze the variance of these different groups to ascertain which factors are most responsible for the variation we observe in the data. Because of the way ANOVA operates, we can actually test multiple different combinations of variables simultaneously in what we call a *two-way ANOVA*.

Don't forget to load your required packages - `tidyverse` and `UNKstats`!

```{r, message = F, echo = F}
library(tidyverse)
library(UNKstats)
```

## Designs

There are several different designs for two-way ANOVAs, and we will cover some of the most common designed here.

For these examples, we are going to randomly generated examples. I will refer to the variables as `Response` and `Explanatory` for simplicity's sake.

### Randomized block design

Randomized block designs look at combinations of variables that could be affecting the results. More specifically, we are looking at two *strata* or *factors* and their effects on a *continuous* response variable.

```{r}
set.seed(8675309)

# random example

# Blocking variable
Blocking_Variable <- c("Group 1", "Group 2", "Group 3")

# explanatory variables
# these are your columns
# these are your primary hypothesis
Explanatory_1 <- c(10.1, 9.4, 11.1)
Explanatory_2 <- c(12, 13.0, 15.4)
Explanatory_3 <- c(11.2, 10.1, 11.9)

# create "data table" as we normally see it
# combine all columns
data_expanded <- cbind(Blocking_Variable,
                       Explanatory_1,
                       Explanatory_2,
                       Explanatory_3) |> 
  as.data.frame() # create data frame

data_expanded
```

*Note* that this table is in the format that we most often see, but we need to reshape these data to make it easier for us to perform our analyses. I created the data here as a matrix with named columns and rows; the following code may need to be adjusted if you do things differently.

```{r}
# expand to "long" format
# if not done earlier, convert to data frame

data <- data_expanded |>
  # !by column for aggregating
  # names_to = what to name column aggregation
  # values_to = what the measurements should be called
  pivot_longer(!Blocking_Variable, names_to = "Explanatory_Variables", values_to = "Measurements")

data[["Measurements"]] <- as.numeric(data[["Measurements"]])
```

Now we can do our ANOVA. ***Note*** that I put `factor` around the blocking variable.

```{r}
# mark block by factor
# best to always use
data_aov <- run_oneway(data = data, 
                       dv = "Measurements", 
                       group = "Explanatory_Variables", 
                       blocking = "Blocking_Variable", 
                       parametric = T)

data_aov$anova_table
```

```{r}
data_aov$plot
```

In this particular example, the blocking variable does not significantly differ, however the explanatory variable does differ.

**Remember, the columns represent your *primary hypothesis*. You will only plot your results if your *primary hypothesis is significant!***

Given that our primary null hypothesis is rejected (that is to say, not all means are equal), we need to plot our results.

### Repeated measures

Now, we are going to do a *repeated measures ANOVA*, where we have the same individuals being measured multiple times. Consider the following imaginary dataset:

```{r}
Visit_1 <- c(5.5,6.2,5.8)
Visit_2 <- c(4.6,5.4,5.2)
Visit_3 <- c(3.8,4.0,3.9)

Individuals <- c(paste0("Individual"," ",1:3))

data <- cbind(Individuals, 
                   Visit_1,
                   Visit_2,
                   Visit_3) |>
  as.data.frame() |> 
  pivot_longer(!Individuals,
               names_to = "Visits",
               values_to = "Measurements")

data[["Measurements"]] <- as.numeric(data[["Measurements"]])

data
```

We need to perform the ANOVA again, but we need to account for the factor of which locations are repeated.

```{r}
repeated_aov <- run_rm(data = data, 
                       dv = "Measurements", 
                       id = "Individuals", 
                       within = "Visits", 
                       which_within = "Visits")

repeated_aov$anova_table
```

```{r}
repeated_aov$plot
```

### Factorial ANOVA

Mathematically, a factorial ANOVA is the same as a randomized block ANOVA; please see that section for information on how to run this test.

### ANOVA with interaction

Sometimes when we running a model, we want to look for *interactive effects*. Interactive effects are situations where one (or both) variables on their own do not effect the data, but there is a cumulative effect between variables that effects things. Let's look at an example, based on our initial example but with the data altered.

```{r}
set.seed(8675309)

# we are using data from the randomized black ANOVA again

data_expanded
```

```{r}
### YOU DO NOT NEED TO DO THIS
### CREATING DATA FOR EXAMPLE

data_expanded$Explanatory_1 <- as.numeric(data_expanded$Explanatory_1)
data_expanded$Explanatory_2 <- as.numeric(data_expanded$Explanatory_2)
data_expanded$Explanatory_3 <- as.numeric(data_expanded$Explanatory_3)

# create some pseudorandom data
# [,-1] excludes first column - group data
data_expanded2 <- cbind(Blocking_Variable,
                        data_expanded[,-1] - 0.75)
data_expanded3 <- cbind(Blocking_Variable,
                        data_expanded[,-1]*1.05)

data_expanded <- rbind(data_expanded,
                       data_expanded2,
                       data_expanded3)

# expand to "long" format
data <- data_expanded |>
  # convert to data frame
  as.data.frame() |>
  # !by column for aggregating
  # names_to = what to name column aggregation
  # values_to = what the measurements should be called
  pivot_longer(!Blocking_Variable, 
               names_to = "Treatments", 
               values_to = "Measurements")
```

```{r}
# specifying factor to be safe

interactive_aov <- run_twoway(data = data, 
                              dv = "Measurements", 
                              factor_a = "Treatments", 
                              factor_b = "Blocking_Variable", 
                              include_interaction = TRUE, 
                              which_factor = "Treatments:Blocking_Variable")
```

```{r}
interactive_aov$anova_table
```

```{r}
interactive_aov$plot
```

## Friedman's test

### Using *R*

Friedman's test is a non-parametric alternative to a two-way ANOVA, so as you would guess, it can be painful to implement. We will use an altered version of the same test we've used before:

```{r}
# set seed - make reproducible
set.seed(8675309)

### DO NOT NEED TO REPEAT THIS
### CREATING DATA FOR EXAMPLE 

# new set of foods - this time, ten of them
Treatments <- c(paste("Treatment",1:10)) |>
  as.factor()

# pre-created data frame of locations from earlier
Blocking_Factor <- c(paste("Block", 1:10)) |>
  as.factor()

long_data <- crossing(Blocking_Factor, Treatments)

long_data$Measurements <- NA

for(i in 1:length(unique(long_data$Treatments))){
  subset_rows <- which(long_data$Treatments==long_data$Treatments[i])
  long_data$Measurements[subset_rows] <- runif(n = length(subset_rows),
                                               min = i-2, max = i+2) |> 
    round(1)
}

long_data
```

Now that we have our expanded and randomized table, we can get started with our test.

Our calculation for the Friedman's test statistic $Q$ (not to be confused with Tukey's $q$!) is: $$Q = \frac{12}{nk(k+1)} \cdot \Sigma R_j^2 - 3n(k+1)$$

where $n$ is the total number of individuals in each sample in the dataset, $k$ is the number of groups, and $R_j^2$ is the sum of the ranks.

**In this class, we will do this in *R*.**

```{r}
friedman_long_data <- friedman.test(y = long_data$Measurements,
                                    groups = long_data$Treatments,
                                    blocks = long_data$Blocking_Factor)

print(friedman_long_data)
```

*Note* you will get a different answer if you are switching the blocks and the groups.

We can use the following, from package `PMCMRplus`, to find the adjacent and non-adjacent groups.

```{r}
library(PMCMRplus)

# find differences
frdAllPairsConoverTest(y = long_data$Measurements,
                       groups = long_data$Treatments,
                       blocks = long_data$Blocking_Factor, 
                       p.adjust.method = "bonf")
```

As we can see, some pairs are inseparable and others are separable. We can now plot as for the other problems.

## Homework: Two-way ANOVA

This homework requires you to install `tidytuesdayR`.

**For each question**:

1.  State your null and alternative hypotheses
2.  Justify what type of ANOVA you think this is and why.
3.  Test for normality relative to the *primary hypothesis*
4.  Perform the appropriate ANOVA
5.  Interpret the results and provide a conclusion
6.  If there are any additional questions, be sure to address them

### Question 1: Stat-y Spice

You and your friends are jamming out to the *Spice Girls*, like you do every Tuesday night, when you get into a heated debate about which of their songs are the most danceable. Amidst all the bickering, you make out that some of your friends are fixated on the year the song came out, while others are arguing that they have more success making "bangers" in major keys than they do in minor keys. In order to save your friend group from infighting, you decide to perform a two-way ANOVA on release year and whether the song is in a major or a minor key and how those factors affect danceability.

Load the following table, where:

-   Release year = `album_release_year`

-   Major or minor key = `mode_name`

-   Danceability = `danceability`

```{r, message = F, eval = F}
tuesdata <- tidytuesdayR::tt_load(2021, week = 51)

studio_album_tracks <- tuesdata$studio_album_tracks
```

```{r, eval = F, results = F, echo = F}
aov <- run_twoway(data = studio_album_tracks,dv = "danceability", 
                  factor_a = "album_release_year", factor_b = "mode_name",
                  include_interaction = TRUE, 
                  which_factor = "album_release_year:mode_name")

studio_album_tracks |> filter(track_name == "Who Do You Think You Are")

aov$plot
```

### Question 2: All alone...

You and your study group are binge-watching the TV show [*Alone*](https://www.history.com/shows/alone) while studying for your history final (it is on the *History* channel, so it has to help somehow, right?). One of your buddies says that the show is inherently unfair, because men are better at survival techniques than women are. This rubs you the wrong way, so you want to see if there is any merit to his claims. You decide to analyze the number of days people are able to last in the show, divided by gender. You also realize that there are cultural differences between countries, so you want to account for any error due to cultural background when you perform your test.

*NOTE:* if you cannot transform this to normal, just run the test on the data "as is".

-   Gender of participant = `gender`

-   Country of origin = `country`

-   Length of time lasted = `days_lasted`

```{r, message = F, eval = F}
tuesdata <- tidytuesdayR::tt_load(2023, week = 4)

alone <- tuesdata$survivalists|> 
  filter(country == "United States" | country == "Canada")
```

```{r, echo = F, eval = F}
aov2 <- run_oneway(data = alone,
                   dv = "days_lasted",
                   group = "gender",
                   blocking = "country",
                   parametric = TRUE)
              

aov2$plot

#aov <- run_rm(data = alone, dv = "days_lasted", id = "country", within = "gender", which_within = "gender")

#aov <- run_twoway(data = alone2, 
#                  dv = "days_lasted", 
#                  factor_a = "gender", 
#                  factor_b = "country", 
#                  include_interaction = T, 
#                  which_factor = "gender:country")

```

### Question 3: Penguins (not of Madagascar)

Talking to Dr. Cooper after class about niche ecology, you become fascinated by the idea of similar species having morphological differences to allow them to co-occur in different areas. You decide to see if there are any morphological differences between penguin species on Antarctic islands. You decide to examine populations of thee congeneric penguins that are regionally sympatric: Adelie Penguin *Pygoscelis adeliae*, Chinstrap Penguin *P. antarcticus*, and Gentoo Penguin *P.* \[*papua*\] *ellsworthi*. You anticipate that there will be differences in bill length among species, but you also know that there is intraspecific competition within species because you did not fall asleep in your evolution class and know that this may also have an effect on bill lengths. In your conclusion, be sure to state which groups are (or are not) different.

```{r, message=FALSE, eval = F}
penguins <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-04-15/penguins.csv')
```

```{r, eval = F, echo = F}
penguins |> group_by(species) |> summarise(pv = shapiro.test(log1p(bill_len))$p.value)

penguins <- penguins |> mutate(log_bill = log1p(bill_len))

aov <- run_twoway(data = penguins, dv = "bill_len", factor_a = "species", factor_b = "sex",
                  include_interaction = T, which_factor = "species:sex")

aov$plot
```

### Question 4: Mankind's biggest foe

Mosquitoes kill more people than any other animal every year. One of the ways in which humans die from mosquitoes is by infecting them with malaria. While malaria has been largely eradicated in North America, it still persists in the Caribbean, Central America, and South America.

Load the `malaria` dataset below, and:

1.  Filter for the `entity` of `Andean Latin America`, `Caribbean`, `Central Latin America`, `Southern Latin America`, and `Tropical Latin America`.
2.  Filter only for years that are 2012 or more recently.
3.  Compare malaria deaths by country, taking into account that year may also be a source of variation for deaths (i.e., via outbreaks).
4.  *These data are non-normal, but for the purposes of this problem, perform a standard ANOVA on the non-transformed data.*

```{r, message = F, eval = F}
malaria <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2018/2018-11-13/malaria_deaths_age.csv')
```

```{r, eval = F, echo = F}
malaria <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2018/2018-11-13/malaria_deaths_age.csv') |> 
  filter(deaths > 0) |> 
  filter(entity == "Andean Latin America" | 
           entity == "Caribbean" | 
           entity == "Central Latin America" | 
           entity == "Southern Latin America" | 
           entity == "Tropical Latin America") |> 
  mutate(age_group = as.factor(age_group)) |> 
  filter(year > 2011)
```

```{r, message = F, echo = F, eval = F}
malaria |> 
  group_by(entity) |> 
  summarise(pv = shapiro.test(log1p(deaths))$p.value)

aov <- run_twoway(data = malaria, dv = "deaths", factor_a = "entity", factor_b = "year", include_interaction = T, which_factor = "entity")

aov$plot
```

### Question 5: Incarceration Rates (Bad Guys?)

It is well known that male driver insurance costs more than female's. But did you know those who live in urban areas also pay more? You want to see if this translates to incarceration rates as well, to truly be able to tell if males are "Bad Guys".

Load the `pretrial` dataset below, and:

1.  Filter for the `male` and `female` populations to exclude total incarceration rates
2.  Compare incarceration rates between `male` and `female` populations, and determine if `urbanicity` plays a role in incarceration rates between these two populations.
3.  *These data are non-normal, but for the purposes of this problem, perform a standard ANOVA on the non-transformed data. **Provide a potential explanation as to why this data is not normal.***

```{r, message=FALSE, eval = F}
pretrial <- readr::read_csv(
  "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-01-22/pretrial_summary.csv"
)

pretrial_anova <- pretrial %>%
  filter(pop_category %in% c("Male", "Female")) %>% 
  mutate(
    urbanicity   = factor(urbanicity),
    pop_category = factor(pop_category)
  )
```

```{r, eval = F, results = F, echo = F}
res_pretrial <- run_twoway(
  data                = pretrial_anova,
  dv                  = "rate_per_100000",
  factor_a            = "urbanicity",      
  factor_b            = "pop_category",   
  include_interaction = TRUE,
  which_factor        = "urbanicity:pop_category" 
)

res_pretrial$plot
```

### Question 6: Your turn!

Using datasets from `tidytuesdayR` ([viewable here](https://github.com/rfordatascience/tidytuesday)), create your own two-way ANOVA homework problem.

-   You are allowed to work with others, but you *must* say who you worked with if you do. Please keep group sizes â‰¤ 4.

-   Your problem *must* include a worked through "key" showing how the homework problem should be done based on the prompt.
